import { NextResponse } from "next/server";
import { routeAIRequest } from "@/lib/ai/router";

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const naics = searchParams.get("naics") || "561720";
  const setAsides = searchParams.get("setAsides") || "8a";
  
  try {
    const response = await fetch(
      `https://api.sam.gov/prod/opportunities/v2/search?api_key=${process.env.SAM_GOV_API_KEY}&naics=${naics}&setAsides=${setAsides}`,
      { headers: { "Accept": "application/json" } }
    );
    const data = await response.json();
    
    const aiSummary = await routeAIRequest(new Request(`https://api/ai/summarize?text=Summarize SAM.gov opportunities for NAICS ${naics}, set-asides ${setAsides}`));
    
    return NextResponse.json({
      success: true,
      data: data.opportunitiesData,
      aiSummary: aiSummary.choices[0].message.content,
    });
  } catch (error) {
    return NextResponse.json({ success: false, error: "Failed to fetch opportunities" }, { status: 500 });
  }
}
